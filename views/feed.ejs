<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>feed page</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <script src="https://unpkg.com/@heroicons/vue@2.1.4/24/outline/index.js"></script>

  <script src="/socket.io/socket.io.js"></script>

</head>

<body>

  <section id="feed-section" class="bg-zinc-900 w-full min-h-screen text-white p-5">

    <div id="notification-container" class="hidden fixed top-5 left-1/2 -translate-x-1/2 
    bg-green-600 px-4 py-2 rounded-lg shadow-lg text-white text-sm transition-all duration-300">
      <p id="notification"></p>
    </div>

    <!-- STORIES -->
    <div class="story-container w-full flex gap-4 overflow-x-auto pb-3 scrollbar-hide">

      <% usersArray.forEach((user)=> { %>
        <div class="flex flex-col items-center cursor-pointer">
          <div
            class="h-20 w-20 rounded-full overflow-hidden border-2 border-pink-500 p-1 hover:scale-105 transition-all duration-200">
            <img src="/uploads/<%= user.profilePic %>" alt="story" class="h-full w-full rounded-full object-cover" />
          </div>
          <p class="text-xs mt-1 text-center opacity-80">
            <%= user.username %>
          </p>
        </div>
        <% }) %>

    </div>

    <!-- POSTS -->
    <div class="post-container flex flex-col gap-6 mt-6 mb-10">
      <% posts.forEach((post)=> { %>

        <div class="w-full bg-zinc-800 rounded-xl shadow-xl overflow-hidden">

          <!-- Post Image -->
          <div class="w-full h-[400px]">
            <img class="w-full h-full object-cover" src="/uploads/<%= post.postPic %>" alt="">
          </div>

          <!-- User + Caption -->
          <div class="p-4">
            <p class="text-sm text-gray-300">
              <span class="font-semibold text-white">
                <%= post.createdBy.username %>
              </span>
              <%= post.caption %>
            </p>
          </div>

          <!-- ACTION BUTTONS -->
          <div class="px-4 py-3 border-t border-zinc-700 flex items-center justify-between text-gray-300">

            <!-- LIKE -->
            <form action="/like/<%= post._id %>" method="POST">
              <button class="flex items-center gap-2 hover:text-white transition">
                <!-- Heart Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 
                   7.636l1.318-1.318a4.5 4.5 
                   0 116.364 6.364L12 21.364 4.318 
                   12.682a4.5 4.5 0 010-6.364z" />
                </svg>
                <span>
                  <%= post.likes.length %>
                </span>
              </button>
            </form>

            <!-- FOLLOW -->
            <form action="/follow-request/<%= post.createdBy._id %>" method="POST">

              <% if (user.following.includes(post.createdBy._id)) { %>
                <button class="bg-gray-700 px-4 py-1 rounded">Following</button>

                <% } else if (user.sentRequests.includes(post.createdBy._id)) { %>
                  <button class="bg-yellow-500 px-4 py-1 rounded">Requested</button>

                  <% } else { %>
                    <button class="bg-blue-600 px-4 py-1 rounded">Follow</button>

                    <% } %>
            </form>

            <!-- COMMENT -->
            <a href="/comment/<%= post._id %>" class="flex items-center gap-2 hover:text-white transition">
              <!-- Comment Icon -->
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M21 
                 12c0 4.418-4.03 8-9 8a9.86 
                 9.86 0 01-3.5-.6L3 21l1.6-4.3A8.3 
                 8.3 0 013 12c0-4.418 4.03-8 9-8s9 
                 3.582 9 8z" />
              </svg>
              <span>Comment</span>
            </a>

          </div>

          <div class="p-4 border-t border-zinc-700 w-full">
            <button id="comment-container-btn" class="text-blue-400">
              View comments
            </button>
            <div id="comment-container" class="flex flex-col w-full h-0 overflow-hidden gap-1 p-1">
              <% post.comments.forEach((c)=> { %>
                <span>
                  <%= c.comment %>
                </span>
                <% }) %>
            </div>
          </div>

        </div>

        <% }) %>
    </div>

  </section>

  <!-- BOTTOM NAVBAR -->
  <footer class="px-8 py-2 bg-zinc-950 text-white flex justify-between items-center fixed bottom-0 w-full">

    <a href="/feed" class="hover:text-blue-400">
      <i class="fa-solid fa-house text-2xl"></i>
    </a>

    <a href="/create-post" class="hover:text-blue-400">
      <i class="fa-solid fa-square-plus text-2xl"></i>
    </a>

    <a href="/profile" class="hover:opacity-80">
      <div class="h-9 w-9 rounded-full overflow-hidden border border-zinc-600">
        <% if (user.profilePic) { %>
          <img src="/uploads/<%= user.profilePic %>" class="h-full w-full object-cover">
          <% } else { %>
            <img src="/profile.jpg" class="h-full w-full object-cover">
            <% } %>
      </div>
    </a>

  </footer>

  <script>
    const notification_container = document.getElementById("notification-container");

    const notification = document.getElementById("notification");

    const commentContainer = document.getElementById("comment-container");
    const ccb = document.getElementById("comment-container-btn");

    ccb.addEventListener("click", () => {
      if (commentContainer.style.height === "0px" || !commentContainer.style.height) {
        // expand to fit content
        commentContainer.style.height = commentContainer.scrollHeight + "px";
        ccb.textContent = "Hide comments";
      } else {
        // collapse
        commentContainer.style.height = "0px";
        ccb.textContent = "View comments";
      }
    });

    // Initially hide notification bar
    notification_container.style.display = "none";

    const socket = io();

    // Join correct room name
    socket.emit("joinRoom", "<%= user._id.toString() %>");

    socket.on("like-notification", (msg) => {
      notification.innerText = msg;
      notification_container.style.display = "block";
      // Auto hide after 3 seconds
      setTimeout(() => {
        notification_container.style.display = "none";
      }, 3000);
    });

    socket.on("follow-request-notification", (msg) => {
      notification.innerText = msg
      notification_container.style.display = "block"
      setTimeout(() => {
        notification_container.style.display = "none"
      }, 3000)
    })

    socket.on("comment-notification", (msg) => {
      notification.innerText = msg
      notification_container.style.display = "block"
      setTimeout(() => {
        notification_container.style.display = "none"
      }, 3000)
    })
  </script>

</body>

</html>